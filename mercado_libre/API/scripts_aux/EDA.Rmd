---
title: "Análisis exploratorio de datos - Aptos ML"
author: "Alvaro Valiño - Lucia Coudet"
date: "2 de mayo de 2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, comment = FALSE, cache = TRUE)
library(readr)
library(here)
library(data.table)
library(tidyverse)
library(knitr)
library(lubridate)
```



```{r datos}
barrios_aptos <- list.files(path = here("mercado_libre/API/datos/apt/202105"), pattern = "*.csv", full.names = T)
barrios_casas <- list.files(path = here("mercado_libre/API/datos/casas/202105"), pattern = "*.csv", full.names = T)

aptos <- sapply(barrios_aptos, FUN=function(id_barrio){
      read_csv(file=id_barrio,col_types = cols(.default = "c"))}, simplify=FALSE) %>% bind_rows()

casas <- sapply(barrios_casas, FUN=function(id_barrio){
      read_csv(file=id_barrio,col_types = cols(.default = "c"))}, simplify=FALSE) %>% bind_rows()

```


```{r}
aptos <- aptos %>%  
      separate(col = 'covered_area', into = c("covered_area", "covered_area_unidad"), sep = "\\s") %>% 
      separate(col = 'total_area', into = c('total_area', 'total_area_unidad'), sep = "\\s") %>%
      mutate(covered_area =  as.numeric(covered_area),
             total_area = as.numeric(total_area),
             price = as.numeric(price),
             latitude = as.numeric(latitude),
             longitude = as.numeric(longitude),
             dia = as_date(dia),
             date_created = as_date(date_created),
             last_updated = as_date(last_updated))
```

```{r NAs}
aptos %>% select(-'mlu1472-mtrs',-'mlu1472-mtrstotal') %>% drop_na()
aptos %>% select(-'mlu1472-mtrs',-'mlu1472-mtrstotal', -'seller_contact') %>% drop_na()
aptos %>% select(-'mlu1472-mtrs',-'mlu1472-mtrstotal', -'seller_contact', -'has_air_conditioning',
                 - 'has_telephone_line') %>% drop_na()
```



```{r state, fig.cap = 'Gráfico de barras del departamento dónde está ubicado el inmueble'}
aptos %>% ggplot() +
      geom_bar(aes(x = fct_infreq(as.factor(state_name)), y = (..count..)/sum(..count..), fill = state_name)) +
      theme(axis.ticks.x = element_blank(),
            legend.position = 'none',
            axis.title.y = element_blank(),
            axis.title.x = element_text(face = 'bold', size = 12),
            axis.text.x = element_text(face = 'bold', angle = 90)) + 
      scale_y_continuous(labels = scales::percent) +
      geom_text(aes(x = as.factor(state_name),label = scales::percent(round((..count..)/sum(..count..), 2)), 
                    y = (..count..)/sum(..count..)), stat = "count", vjust = -0.5, size = 2) + 
      labs(x = 'Departamento', fill = 'Departamento')
```




```{r operacion, fig,cap = 'Gráfico de barras del tipo de operación de los apartamentos'}
aptos %>% ggplot() +
      geom_bar(aes(x = fct_infreq(as.factor(operation)), y = (..count..)/sum(..count..), fill = operation)) +
      theme(axis.ticks.x = element_blank(),
            legend.position = 'none',
            axis.title.y = element_blank(),
            axis.title.x = element_text(face = 'bold', size = 12),
            axis.text.x = element_text(face = 'bold')) + 
      scale_y_continuous(labels = scales::percent) +
      geom_text(aes(x = as.factor(operation),label = scales::percent(round((..count..)/sum(..count..), 2)), 
                    y = (..count..)/sum(..count..)), stat = "count", vjust = -0.5, size = 4) + 
      labs(x = 'Tipo de operación') +
      scale_fill_manual(labels = c('Venta','Alquiler','Alquiler temporal'), values = c('navyblue', 'darkgreen', 'firebrick'))

```


```{r precio, fig.cap='Gráfico de Violin del precio de publicación (en logaritmos) según el tipo de operación'}

aptos %>% ggplot(aes(x=as.character(operation), y=log(price), fill=as.character(operation))) + 
      geom_violin() +
      theme(text = element_text( family = 'sans'),
            axis.title.y = element_text( size = 14),
            axis.title.x = element_blank(),
            plot.title = element_blank(),
            legend.title = element_blank(),
            axis.text.x = element_text(face = 'bold', size = 12),
            axis.text.y = element_text(face = 'bold', size = 12),
            legend.position = 'none') +
      scale_x_discrete(labels=c('Alquiler', 'Alquiler temporal', 'Venta')) +
      ylab('Precio de publicación (en logaritmos)') +
      geom_boxplot(width=0.1, colour='black', outlier.color = 'black') +
      scale_fill_manual(values = c('navyblue', 'darkgreen', 'firebrick'))

```


```{r itemcond, fig.cap='Gráfico de barras de la condición del apartamento'}
aptos %>% ggplot() +
      geom_bar(aes(x = fct_infreq(as.factor(item_condition)), y = (..count..)/sum(..count..), fill = item_condition)) +
      theme(axis.ticks.x = element_blank(),
            legend.position = 'none',
            axis.title.y = element_blank(),
            axis.title.x = element_text(face = 'bold', size = 12),
            axis.text.x = element_text(face = 'bold')) + 
      scale_y_continuous(labels = scales::percent) +
      geom_text(aes(x = as.factor(item_condition),label = scales::percent(round((..count..)/sum(..count..), 2)), 
                    y = (..count..)/sum(..count..)), stat = "count", vjust = -0.5, size = 4) + 
      labs(x = 'Condición del apartamento', fill = 'Condición del apartamento')

```


```{r itemcondv, fig.cap='Gráfico de Violin del precio de publicación (en logaritmos) según la condición del item'}

aptos %>% ggplot(aes(x=as.character(item_condition), y=log(price), fill=as.character(item_condition))) + 
      geom_violin() +
      theme(text = element_text( family = 'sans'),
            axis.title.y = element_text( size = 14),
            axis.title.x = element_blank(),
            plot.title = element_blank(),
            legend.title = element_blank(),
            axis.text.x = element_text(face = 'bold', size = 12),
            axis.text.y = element_text(face = 'bold', size = 12),
            legend.position = 'none') +
                  scale_x_discrete() +
      ylab('Precio de publicación (en logaritmos)') +
      geom_boxplot(width=0.1, colour='black', outlier.color = 'black') 

```



```{r itemcondop, fig.cap='Gráfico de Violin del precio de publicación (en logaritmos) según la condición del item y por tipo de operación'}

aptos %>% ggplot(aes(x=as.character(item_condition), y=log(price), fill=as.character(item_condition))) + 
      geom_violin() +
      theme(text = element_text( family = 'sans'),
            axis.title.y = element_text( size = 14),
            axis.title.x = element_blank(),
            plot.title = element_blank(),
            legend.title = element_blank(),
            axis.text.x = element_text(face = 'bold', size = 12),
            axis.text.y = element_text(face = 'bold', size = 12),
            legend.position = 'none') +
                  scale_x_discrete() +
      ylab('Precio de publicación (en logaritmos)') +
      geom_boxplot(width=0.1, colour='black', outlier.color = 'black') +
      facet_wrap(~operation, ncol = 3)

```



```{r fullbath, fig.cap = 'Gráfico de barras de la cantidad de baños completos'}
aptos %>% ggplot() +
      geom_bar(aes(x = fct_infreq(as.factor(full_bathrooms)), y = (..count..)/sum(..count..), fill = full_bathrooms)) +
      theme(axis.ticks.x = element_blank(),
            legend.position = 'none',
            axis.title.y = element_blank(),
            axis.title.x = element_text(face = 'bold', size = 12),
            axis.text.x = element_text(face = 'bold')) + 
      scale_y_continuous(labels = scales::percent) +
      geom_text(aes(x = as.factor(full_bathrooms),label = scales::percent(round((..count..)/sum(..count..), 2)), 
                    y = (..count..)/sum(..count..)), stat = "count", vjust = -0.5, size = 3) + 
      labs(x = 'Cantidad de baños completos')

```


```{r bedrooms, fig.cap = 'Gráfico de barras de la cantidad de habitaciones'}
aptos %>% ggplot() +
      geom_bar(aes(x = fct_infreq(as.factor(bedrooms)), y = (..count..)/sum(..count..), fill = bedrooms)) +
      theme(axis.ticks.x = element_blank(),
            legend.position = 'none',
            axis.title.y = element_blank(),
            axis.title.x = element_text(face = 'bold', size = 12),
            axis.text.x = element_text(face = 'bold')) + 
      scale_y_continuous(labels = scales::percent) +
      geom_text(aes(x = as.factor(bedrooms),label = scales::percent(round((..count..)/sum(..count..), 2)), 
                    y = (..count..)/sum(..count..)), stat = "count", vjust = -0.5, size = 2) + 
      labs(x = 'Cantidad de dormitorios')
```

```{r rooms, fig.cap = 'Gráfico de barras de la cantidad de habitaciones'}
aptos %>% ggplot() +
      geom_bar(aes(x = fct_infreq(as.factor(rooms)), y = (..count..)/sum(..count..), fill = rooms)) +
      theme(axis.ticks.x = element_blank(),
            legend.position = 'none',
            axis.title.y = element_blank(),
            axis.title.x = element_text(face = 'bold', size = 12),
            axis.text.x = element_text(face = 'bold')) + 
      scale_y_continuous(labels = scales::percent) +
      geom_text(aes(x = as.factor(rooms),label = scales::percent(round((..count..)/sum(..count..), 2)), 
                    y = (..count..)/sum(..count..)), stat = "count", vjust = -0.5, size = 2) + 
      labs(x = 'Cantidad de dormitorios')
```


```{r area, fig.cap='Histograma del área cubierta (en m2). Cómo es de esperar dado que estamos trabajando con información de apartamentos, el área total y área cubierta resulta similar'}

aptos %>% select(covered_area, total_area) %>% 
      pivot_longer(cols = c('covered_area','total_area'), names_to = c('Area')) %>% 
      ggplot() +
      geom_histogram(aes(x = value, fill = Area)) +
      theme(axis.ticks.x = element_blank(),
            legend.position = 'none',
            axis.title.y = element_blank(),
            axis.title.x = element_text(face = 'bold', size = 12),
            axis.text.x = element_text(face = 'bold')) +
      xlim(0,200) +
      labs(x = 'Área (en m2)') +
      scale_fill_manual(values = c('firebrick', 'darkgreen')) +
      facet_wrap(~Area)
```


```{r calidadpic, fig.cap='Gráfico de barras de la calidad de la imágen' }

aptos %>% ggplot() +
      geom_bar(aes(x = fct_infreq(as.factor(tags)), y = (..count..)/sum(..count..), fill = tags)) +
      theme(axis.ticks.x = element_blank(),
            legend.position = 'none',
            axis.title.y = element_blank(),
            axis.title.x = element_text(face = 'bold', size = 12),
            axis.text.x = element_text(face = 'bold')) + 
      scale_y_continuous(labels = scales::percent) +
      geom_text(aes(x = as.factor(tags),label = scales::percent(round((..count..)/sum(..count..), 2)), 
                    y = (..count..)/sum(..count..)), stat = "count", vjust = -0.5, size = 4) + 
      labs(x = 'Calidad de la imágen')

```


```{r precio, fig.cap='Gráfico de Violin del precio de publicación (en logaritmos) según la calidad de la imagen'}

aptos %>% ggplot(aes(x=as.character(tags), y=log(price), fill=as.character(tags))) + 
      geom_violin() +
      theme(text = element_text( family = 'sans'),
            axis.title.y = element_text( size = 14),
            axis.title.x = element_blank(),
            plot.title = element_blank(),
            legend.title = element_blank(),
            axis.text.x = element_text(face = 'bold', size = 12),
            axis.text.y = element_text(face = 'bold', size = 12),
            legend.position = 'none')  +
      ylab('Precio de publicación (en logaritmos)') +
      geom_boxplot(width=0.1, colour='black', outlier.color = 'black') +
      scale_fill_manual(values = c('navyblue', 'darkgreen', 'firebrick', 'gray')) # no reconoce color

```





```{r aircond, fig.cap = 'Tiene aire acondicionado'}
aptos %>% ggplot() +
      geom_bar(aes(x = fct_infreq(as.factor(has_air_conditioning)), y = (..count..)/sum(..count..), fill = has_air_conditioning)) +
      theme(axis.ticks.x = element_blank(),
            legend.position = 'none',
            axis.title.y = element_blank(),
            axis.title.x = element_text(face = 'bold', size = 12),
            axis.text.x = element_text(face = 'bold')) + 
      scale_y_continuous(labels = scales::percent) +
      geom_text(aes(x = as.factor(has_air_conditioning),label = scales::percent(round((..count..)/sum(..count..), 2)), 
                    y = (..count..)/sum(..count..)), stat = "count", vjust = -0.5, size = 4) + 
      labs(x = 'Tiene aire acondicionado')



```




```{r line, fig.cap = 'Tiene línea telefónica'}
aptos %>% ggplot() +
      geom_bar(aes(x = fct_infreq(as.factor(has_telephone_line)), y = (..count..)/sum(..count..), fill = has_telephone_line)) +
      theme(axis.ticks.x = element_blank(),
            legend.position = 'none',
            axis.title.y = element_blank(),
            axis.title.x = element_text(face = 'bold', size = 12),
            axis.text.x = element_text(face = 'bold')) + 
      scale_y_continuous(labels = scales::percent) +
      geom_text(aes(x = as.factor(has_telephone_line),label = scales::percent(round((..count..)/sum(..count..), 2)), 
                    y = (..count..)/sum(..count..)), stat = "count", vjust = -0.5, size = 4) + 
      labs(x = 'Tiene línea telefónica')
```



```{r, eval = FALSE}
aptos %>% group_by(property_type) %>% summarise(conteo = n())
aptos %>% group_by(farm_house_rooms) %>% summarise(conteo = n())
aptos %>% group_by(buying_mode) %>% summarise(conteo = n())
aptos %>% group_by(condition) %>% summarise(conteo = n())
aptos %>% group_by(item_condition) %>% summarise(conteo = n())
```

\newpage

```{r, results='asis'}
kable(aptos %>% filter(state_name == 'Montevideo') %>%
      group_by(city_name) %>% summarise(conteo = n()) %>%
      mutate(prop = conteo/sum(conteo)*100) %>%
      arrange(desc(prop))) 

```

















