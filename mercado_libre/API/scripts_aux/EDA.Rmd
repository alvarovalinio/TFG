---
title: "Análisis exploratorio de datos - Aptos ML"
author: "Alvaro Valiño - Lucia Coudet"
date: "2 de mayo de 2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, comment = FALSE)
```

```{r}
load("datos_apt.Rdata")
library(tidyverse)
library(knitr)

datos_apt <- datos_apt %>%  
      separate(col = 'covered_area', into = c("covered_area", "covered_area_unidad"), sep = "\\s") %>% 
      separate(col = 'total_area', into = c('total_area', 'total_area_unidad'), sep = "\\s") %>%
      mutate(covered_area =  as.numeric(covered_area),
             total_area = as.numeric(total_area))


```


```{r state, fig.cap = 'Gráfico de barras del departamento dónde está ubicado el inmueble'}
datos_apt %>% ggplot() +
      geom_bar(aes(x = fct_infreq(as.factor(state_name)), y = (..count..)/sum(..count..), fill = state_name)) +
      theme(axis.ticks.x = element_blank(),
            legend.position = 'none',
            axis.title.y = element_blank(),
            axis.title.x = element_text(face = 'bold', size = 12),
            axis.text.x = element_text(face = 'bold', angle = 90)) + 
      scale_y_continuous(labels = scales::percent) +
      geom_text(aes(x = as.factor(state_name),label = scales::percent(round((..count..)/sum(..count..), 2)), 
                    y = (..count..)/sum(..count..)), stat = "count", vjust = -0.5, size = 2) + 
      labs(x = 'Departamento', fill = 'Departamento')
```



De ahora en más, trabajamos filtrando al depto de interés: Montevideo.


```{r}
datos_apt <- datos_apt %>% filter(state_name == 'Montevideo')
```



```{r operacion, fig,cap = 'Gráfico de barras del tipo de operación de los apartamentos'}
datos_apt %>% ggplot() +
      geom_bar(aes(x = fct_infreq(as.factor(operation)), y = (..count..)/sum(..count..), fill = operation)) +
      theme(axis.ticks.x = element_blank(),
            legend.position = 'none',
            axis.title.y = element_blank(),
            axis.title.x = element_text(face = 'bold', size = 12),
            axis.text.x = element_text(face = 'bold')) + 
      scale_y_continuous(labels = scales::percent) +
      geom_text(aes(x = as.factor(operation),label = scales::percent(round((..count..)/sum(..count..), 2)), 
                    y = (..count..)/sum(..count..)), stat = "count", vjust = -0.5, size = 4) + 
      labs(x = 'Tipo de operación') +
      scale_fill_manual(labels = c('Venta','Alquiler','Alquiler temporal'), values = c('navyblue', 'darkgreen', 'firebrick'))

```


```{r precio, fig.cap='Gráfico de Violin del precio de publicación (en logaritmos) según el tipo de operación'}

datos_apt %>% ggplot(aes(x=as.character(operation), y=log(price), fill=as.character(operation))) + 
      geom_violin() +
      theme(text = element_text( family = 'sans'),
            axis.title.y = element_text( size = 14),
            axis.title.x = element_blank(),
            plot.title = element_blank(),
            legend.title = element_blank(),
            axis.text.x = element_text(face = 'bold', size = 12),
            axis.text.y = element_text(face = 'bold', size = 12),
            legend.position = 'none') +
      scale_x_discrete(labels=c('Alquiler', 'Alquiler temporal', 'Venta')) +
      ylab('Precio de publicación (en logaritmos)') +
      geom_boxplot(width=0.1, colour='black', outlier.color = 'black') +
      scale_fill_manual(values = c('navyblue', 'darkgreen', 'firebrick'))

```


```{r itemcond, fig.cap='Gráfico de barras de la condición del apartamento'}
datos_apt %>% ggplot() +
      geom_bar(aes(x = fct_infreq(as.factor(item_condition)), y = (..count..)/sum(..count..), fill = item_condition)) +
      theme(axis.ticks.x = element_blank(),
            legend.position = 'none',
            axis.title.y = element_blank(),
            axis.title.x = element_text(face = 'bold', size = 12),
            axis.text.x = element_text(face = 'bold')) + 
      scale_y_continuous(labels = scales::percent) +
      geom_text(aes(x = as.factor(item_condition),label = scales::percent(round((..count..)/sum(..count..), 2)), 
                    y = (..count..)/sum(..count..)), stat = "count", vjust = -0.5, size = 4) + 
      labs(x = 'Condición del apartamento', fill = 'Condición del apartamento')

```


```{r itemcondv, fig.cap='Gráfico de Violin del precio de publicación (en logaritmos) según la condición del item'}

datos_apt %>% ggplot(aes(x=as.character(item_condition), y=log(price), fill=as.character(item_condition))) + 
      geom_violin() +
      theme(text = element_text( family = 'sans'),
            axis.title.y = element_text( size = 14),
            axis.title.x = element_blank(),
            plot.title = element_blank(),
            legend.title = element_blank(),
            axis.text.x = element_text(face = 'bold', size = 12),
            axis.text.y = element_text(face = 'bold', size = 12),
            legend.position = 'none') +
                  scale_x_discrete() +
      ylab('Precio de publicación (en logaritmos)') +
      geom_boxplot(width=0.1, colour='black', outlier.color = 'black') 

```



```{r itemcondop, fig.cap='Gráfico de Violin del precio de publicación (en logaritmos) según la condición del item y por tipo de operación'}

datos_apt %>% ggplot(aes(x=as.character(item_condition), y=log(price), fill=as.character(item_condition))) + 
      geom_violin() +
      theme(text = element_text( family = 'sans'),
            axis.title.y = element_text( size = 14),
            axis.title.x = element_blank(),
            plot.title = element_blank(),
            legend.title = element_blank(),
            axis.text.x = element_text(face = 'bold', size = 12),
            axis.text.y = element_text(face = 'bold', size = 12),
            legend.position = 'none') +
                  scale_x_discrete() +
      ylab('Precio de publicación (en logaritmos)') +
      geom_boxplot(width=0.1, colour='black', outlier.color = 'black') +
      facet_wrap(~operation, ncol = 3)

```



```{r fullbath, fig.cap = 'Gráfico de barras de la cantidad de baños completos'}
datos_apt %>% ggplot() +
      geom_bar(aes(x = fct_infreq(as.factor(full_bathrooms)), y = (..count..)/sum(..count..), fill = full_bathrooms)) +
      theme(axis.ticks.x = element_blank(),
            legend.position = 'none',
            axis.title.y = element_blank(),
            axis.title.x = element_text(face = 'bold', size = 12),
            axis.text.x = element_text(face = 'bold')) + 
      scale_y_continuous(labels = scales::percent) +
      geom_text(aes(x = as.factor(full_bathrooms),label = scales::percent(round((..count..)/sum(..count..), 2)), 
                    y = (..count..)/sum(..count..)), stat = "count", vjust = -0.5, size = 3) + 
      labs(x = 'Cantidad de baños completos')

```


```{r bedrooms, fig.cap = 'Gráfico de barras de la cantidad de habitaciones'}
datos_apt %>% ggplot() +
      geom_bar(aes(x = fct_infreq(as.factor(bedrooms)), y = (..count..)/sum(..count..), fill = bedrooms)) +
      theme(axis.ticks.x = element_blank(),
            legend.position = 'none',
            axis.title.y = element_blank(),
            axis.title.x = element_text(face = 'bold', size = 12),
            axis.text.x = element_text(face = 'bold')) + 
      scale_y_continuous(labels = scales::percent) +
      geom_text(aes(x = as.factor(bedrooms),label = scales::percent(round((..count..)/sum(..count..), 2)), 
                    y = (..count..)/sum(..count..)), stat = "count", vjust = -0.5, size = 2) + 
      labs(x = 'Cantidad de dormitorios')
```

```{r rooms, fig.cap = 'Gráfico de barras de la cantidad de habitaciones'}
datos_apt %>% ggplot() +
      geom_bar(aes(x = fct_infreq(as.factor(rooms)), y = (..count..)/sum(..count..), fill = rooms)) +
      theme(axis.ticks.x = element_blank(),
            legend.position = 'none',
            axis.title.y = element_blank(),
            axis.title.x = element_text(face = 'bold', size = 12),
            axis.text.x = element_text(face = 'bold')) + 
      scale_y_continuous(labels = scales::percent) +
      geom_text(aes(x = as.factor(rooms),label = scales::percent(round((..count..)/sum(..count..), 2)), 
                    y = (..count..)/sum(..count..)), stat = "count", vjust = -0.5, size = 2) + 
      labs(x = 'Cantidad de dormitorios')
```


```{r area, fig.cap='Histograma del área cubierta (en m2). Cómo es de esperar dado que estamos trabajando con información de apartamentos, el área total y área cubierta resulta similar'}

datos_apt %>% select(covered_area, total_area) %>% 
      pivot_longer(cols = c('covered_area','total_area'), names_to = c('Area')) %>% 
      ggplot() +
      geom_histogram(aes(x = value, fill = Area)) +
      theme(axis.ticks.x = element_blank(),
            legend.position = 'none',
            axis.title.y = element_blank(),
            axis.title.x = element_text(face = 'bold', size = 12),
            axis.text.x = element_text(face = 'bold')) +
      xlim(0,200) +
      labs(x = 'Área (en m2)') +
      scale_fill_manual(values = c('firebrick', 'darkgreen')) +
      facet_wrap(~Area)
```


```{r calidadpic, fig.cap='Gráfico de barras de la calidad de la imágen' }

datos_apt %>% ggplot() +
      geom_bar(aes(x = fct_infreq(as.factor(tags)), y = (..count..)/sum(..count..), fill = tags)) +
      theme(axis.ticks.x = element_blank(),
            legend.position = 'none',
            axis.title.y = element_blank(),
            axis.title.x = element_text(face = 'bold', size = 12),
            axis.text.x = element_text(face = 'bold')) + 
      scale_y_continuous(labels = scales::percent) +
      geom_text(aes(x = as.factor(tags),label = scales::percent(round((..count..)/sum(..count..), 2)), 
                    y = (..count..)/sum(..count..)), stat = "count", vjust = -0.5, size = 4) + 
      labs(x = 'Calidad de la imágen')

```

```{r aircond, fig.cap = 'Tiene aire acondicionado'}
datos_apt %>% ggplot() +
      geom_bar(aes(x = fct_infreq(as.factor(has_air_conditioning)), y = (..count..)/sum(..count..), fill = has_air_conditioning)) +
      theme(axis.ticks.x = element_blank(),
            legend.position = 'none',
            axis.title.y = element_blank(),
            axis.title.x = element_text(face = 'bold', size = 12),
            axis.text.x = element_text(face = 'bold')) + 
      scale_y_continuous(labels = scales::percent) +
      geom_text(aes(x = as.factor(has_air_conditioning),label = scales::percent(round((..count..)/sum(..count..), 2)), 
                    y = (..count..)/sum(..count..)), stat = "count", vjust = -0.5, size = 4) + 
      labs(x = 'Tiene aire acondicionado')



```




```{r line, fig.cap = 'Tiene línea telefónica'}
datos_apt %>% ggplot() +
      geom_bar(aes(x = fct_infreq(as.factor(has_telephone_line)), y = (..count..)/sum(..count..), fill = has_telephone_line)) +
      theme(axis.ticks.x = element_blank(),
            legend.position = 'none',
            axis.title.y = element_blank(),
            axis.title.x = element_text(face = 'bold', size = 12),
            axis.text.x = element_text(face = 'bold')) + 
      scale_y_continuous(labels = scales::percent) +
      geom_text(aes(x = as.factor(has_telephone_line),label = scales::percent(round((..count..)/sum(..count..), 2)), 
                    y = (..count..)/sum(..count..)), stat = "count", vjust = -0.5, size = 4) + 
      labs(x = 'Tiene línea telefónica')
```



```{r, eval = FALSE}
datos_apt %>% group_by(property_type) %>% summarise(conteo = n())
datos_apt %>% group_by(farm_house_rooms) %>% summarise(conteo = n())
datos_apt %>% group_by(buying_mode) %>% summarise(conteo = n())
datos_apt %>% group_by(condition) %>% summarise(conteo = n())
datos_apt %>% group_by(item_condition) %>% summarise(conteo = n())
```



```{r, results='asis'}
kable(datos_apt %>% filter(state_name == 'Montevideo') %>%
      group_by(city_name) %>% summarise(conteo = n()) %>%
      mutate(prop = conteo/sum(conteo)*100) %>%
      arrange(desc(prop)) %>% filter(prop > 2))  

```

















