---
title: "Análisis exploratorio de datos - Casas ML"
author: "Alvaro Valiño - Lucia Coudet"
date: "19 de mayo de 2021"
output: pdf_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, comment = FALSE, cache = FALSE)
library(readr)
library(here)
library(data.table)
library(tidyverse)
library(knitr)
library(lubridate)
```



```{r datos}
barrios_aptos <- list.files(path = here("mercado_libre/API/datos/apt/202105"), pattern = "*.csv", full.names = T)
barrios_casas <- list.files(path = here("mercado_libre/API/datos/casas/202105"), pattern = "*.csv", full.names = T)

aptos <- sapply(barrios_aptos, FUN=function(id_barrio){
      read_csv(file=id_barrio,col_types = cols(.default = "c"))}, simplify=FALSE) %>% bind_rows()

casas <- sapply(barrios_casas, FUN=function(id_barrio){
      read_csv(file=id_barrio,col_types = cols(.default = "c"))}, simplify=FALSE) %>% bind_rows()

```


```{r}
casas <- casas %>%  
      separate(col = 'covered_area', into = c("covered_area", "covered_area_unidad"), sep = "\\s") %>% 
      separate(col = 'total_area', into = c('total_area', 'total_area_unidad'), sep = "\\s") %>%
      mutate(covered_area =  as.numeric(covered_area),
             total_area = as.numeric(total_area),
             price = as.numeric(price),
             latitude = as.numeric(latitude),
             longitude = as.numeric(longitude),
             dia = as_date(dia),
             date_created = as_date(date_created),
             last_updated = as_date(last_updated))
```


El total de observaciones sin `NA` es de:
      
```{r NAs}
dim(casas %>% select(-'mlu1466-mtrs',-'mlu1466-mtrstotal', -'seller_contact', -'has_air_conditioning',
                     - 'has_telephone_line', - 'rooms') %>% drop_na())[1]
```

Sobrre un total de `10769` observaciones, lo cual representa el  `70 %` de las observaciones (hubo que quitar variable rooms por tener muchos NA). 


```{r precio,  fig.cap='Histograma del precio de oferta de los casas a la venta en Montevideo (en logaritmos)'}

casas %>% ggplot(aes(x=log(price))) + 
      geom_histogram(fill = 'darkgreen', alpha = 1, bins = 30) +
      theme(axis.ticks.x = element_blank(),
            legend.position = 'none',
            axis.title.y = element_blank(),
            axis.title.x = element_text(face = 'bold', size = 12),
            axis.text.x = element_text(face = 'bold')) +
      xlim(9,16) +
      labs(x = 'Precio de oferta (en logaritmos)') +
      scale_fill_manual(values = c('darkgreen')) 

```


```{r itemconbar, fig.cap='Gráfico de barras de la condición de la casa'}
casas %>% ggplot() +
      geom_bar(aes(x = fct_infreq(as.factor(item_condition)), y = (..count..)/sum(..count..), fill = item_condition)) +
      theme(axis.ticks.x = element_blank(),
            legend.position = 'none',
            axis.title.y = element_blank(),
            axis.title.x = element_text(face = 'bold', size = 12),
            axis.text.x = element_text(face = 'bold')) + 
      scale_y_continuous(labels = scales::percent) +
      geom_text(aes(x = as.factor(item_condition),label = scales::percent(round((..count..)/sum(..count..), 2)), 
                    y = (..count..)/sum(..count..)), stat = "count", vjust = -0.5, size = 4) + 
      labs(x = 'Condición del casa', fill = 'Condición de la casa') 

```


```{r itemcondviolin, fig.cap='Gráfico de Violin del precio de publicación (en logaritmos) según la condición del item'}

casas %>% ggplot(aes(x=as.character(item_condition), y=log(price), fill=as.character(item_condition))) + 
      geom_violin() +
      theme(text = element_text( family = 'sans'),
            axis.title.y = element_text( size = 14),
            axis.title.x = element_blank(),
            plot.title = element_blank(),
            legend.title = element_blank(),
            axis.text.x = element_text(face = 'bold', size = 12),
            axis.text.y = element_text(face = 'bold', size = 12),
            legend.position = 'none') +
      scale_x_discrete() +
      ylab('Precio de publicación (en logaritmos)') +
      geom_boxplot(width=0.1, colour='black', outlier.color = 'black') 

```



```{r itemcond2,  fig.cap='Gráfico de Violin del precio de publicación (en logaritmos) según la condición del item y la cantidad de baños'}

casas %>% mutate(full_bathrooms = as.numeric(full_bathrooms),
                 banios = ifelse(is.na(full_bathrooms), NA,
                                 ifelse(full_bathrooms == '1', 'Un solo baño', 
                                        'Mas de un baño'))) %>%
      ggplot(aes(x=as.character(item_condition), y=log(price), fill=as.character(item_condition))) + 
      geom_violin() +
      theme(text = element_text( family = 'sans'),
            axis.title.y = element_text( size = 14),
            axis.title.x = element_blank(),
            plot.title = element_blank(),
            legend.title = element_blank(),
            axis.text.x = element_text(face = 'bold', size = 12),
            axis.text.y = element_text(face = 'bold', size = 12),
            legend.position = 'none') +
      scale_x_discrete() +
      ylab('Precio de publicación (en logaritmos)') +
      geom_boxplot(width=0.1, colour='black', outlier.color = 'black') +
      facet_wrap(~banios, ncol = 3)

```



```{r fullbath, fig.cap = 'Gráfico de barras de la cantidad de baños completos'}
casas %>% ggplot() +
      geom_bar(aes(x = fct_infreq(as.factor(full_bathrooms)), y = (..count..)/sum(..count..), fill = full_bathrooms)) +
      theme(axis.ticks.x = element_blank(),
            legend.position = 'none',
            axis.title.y = element_blank(),
            axis.title.x = element_text(face = 'bold', size = 12),
            axis.text.x = element_text(face = 'bold')) + 
      scale_y_continuous(labels = scales::percent) +
      geom_text(aes(x = as.factor(full_bathrooms),label = scales::percent(round((..count..)/sum(..count..), 2)), 
                    y = (..count..)/sum(..count..)), stat = "count", vjust = -0.5, size = 3) + 
      labs(x = 'Cantidad de baños completos')

```

```{r pricebath, fig.cap='Gráfico de Violin del precio de publicación (en logaritmos) según la casa tenga un solo baño (o ninguno) completo o más de uno'}

casas %>% mutate(full_bathrooms = as.numeric(full_bathrooms),
                 banios = ifelse(is.na(full_bathrooms), NA,
                                 ifelse(full_bathrooms == 1 | full_bathrooms == 0 , 'Un solo baño', 
                                        'Mas de un baño'))) %>%
      filter(!is.na(full_bathrooms)) %>%
      ggplot(aes(x=as.character(banios), y=log(price), fill=as.character(banios))) + 
      geom_violin() +
      theme(text = element_text( family = 'sans'),
            axis.title.y = element_text( size = 14),
            axis.title.x = element_blank(),
            plot.title = element_blank(),
            legend.title = element_blank(),
            axis.text.x = element_text(face = 'bold', size = 12),
            axis.text.y = element_text(face = 'bold', size = 12),
            legend.position = 'none') +
      scale_x_discrete() +
      ylab('Precio de publicación (en logaritmos)') +
      geom_boxplot(width=0.1, colour='black', outlier.color = 'black')

```

```{r pricebath2, fig.cap='Gráfico de Violin del precio de publicación (en logaritmos) según el casa tenga uno o dos baños completoa o más de dos'}

casas %>% mutate(full_bathrooms = as.numeric(full_bathrooms),
                 banios = ifelse(is.na(full_bathrooms), NA,
                                 ifelse(full_bathrooms < 2, 'Dos o menos de 2 baños completos', 
                                        'Mas de 2 baños completos'))) %>%
      filter(!is.na(full_bathrooms)) %>%
      ggplot(aes(x=as.character(banios), y=log(price), fill=as.character(banios))) + 
      geom_violin() +
      theme(text = element_text( family = 'sans'),
            axis.title.y = element_text( size = 14),
            axis.title.x = element_blank(),
            plot.title = element_blank(),
            legend.title = element_blank(),
            axis.text.x = element_text(face = 'bold', size = 12),
            axis.text.y = element_text(face = 'bold', size = 12),
            legend.position = 'none') +
      scale_x_discrete() +
      ylab('Precio de publicación (en logaritmos)') +
      geom_boxplot(width=0.1, colour='black', outlier.color = 'black') +
      ylim(8,16)

```



```{r rooms, fig.cap = 'Gráfico de barras de la cantidad de habitaciones'}
casas %>% ggplot() +
      geom_bar(aes(x = fct_infreq(as.factor(bedrooms)), y = (..count..)/sum(..count..), fill = bedrooms)) +
      theme(axis.ticks.x = element_blank(),
            legend.position = 'none',
            axis.title.y = element_blank(),
            axis.title.x = element_text(face = 'bold', size = 12),
            axis.text.x = element_text(face = 'bold')) + 
      scale_y_continuous(labels = scales::percent) +
      geom_text(aes(x = as.factor(bedrooms),label = scales::percent(round((..count..)/sum(..count..), 2)), 
                    y = (..count..)/sum(..count..)), stat = "count", vjust = -0.5, size = 2) + 
      labs(x = 'Cantidad de dormitorios')
```


```{r pricerooms, fig.cap='Gráfico de Violin del precio de publicación (en logaritmos) según la casa tenga 4 o menos ambientes, o más de 4'}

casas %>% mutate(rooms = as.numeric(rooms),
                 rooms_discrete = ifelse(is.na(rooms), NA,
                                         ifelse(rooms <= 4, '4 o menos de 4 ambientes', 
                                                'Mas de 4 ambientes'))) %>%
      filter(!is.na(rooms)) %>%
      ggplot(aes(x=as.character(rooms_discrete), y=log(as.numeric(price)), fill=as.character(rooms_discrete))) + 
      geom_violin() +
      theme(text = element_text( family = 'sans'),
            axis.title.y = element_text( size = 14),
            axis.title.x = element_blank(),
            plot.title = element_blank(),
            legend.title = element_blank(),
            axis.text.x = element_text(face = 'bold', size = 12),
            axis.text.y = element_text(face = 'bold', size = 12),
            legend.position = 'none') +
      scale_x_discrete() +
      ylab('Precio de publicación (en logaritmos)') +
      geom_boxplot(width=0.1, colour='black', outlier.color = 'black') +
      ylim(10,15)

```



```{r bedrooms, fig.cap = 'Gráfico de barras de la cantidad de dormitorios'}
casas %>% ggplot() +
      geom_bar(aes(x = fct_infreq(as.factor(rooms)), y = (..count..)/sum(..count..), fill = rooms)) +
      theme(axis.ticks.x = element_blank(),
            legend.position = 'none',
            axis.title.y = element_blank(),
            axis.title.x = element_text(face = 'bold', size = 12),
            axis.text.x = element_text(face = 'bold')) + 
      scale_y_continuous(labels = scales::percent) +
      geom_text(aes(x = as.factor(rooms),label = scales::percent(round((..count..)/sum(..count..), 2)), 
                    y = (..count..)/sum(..count..)), stat = "count", vjust = -0.5, size = 2) + 
      labs(x = 'Cantidad de dormitorios')
```


```{r pricebedrooms, fig.cap='Gráfico de Violin del precio de publicación (en logaritmos) según la casa tenga dos o menos dormitorios, o más de dos'}

casas %>% mutate(bedrooms = as.numeric(bedrooms),
                 bedrooms_discrete = ifelse(is.na(bedrooms), NA,
                                         ifelse(bedrooms <= 2, '2 o menos de 2 dormitorios', 
                                                'Mas de 2 dormitorios'))) %>%
      filter(!is.na(bedrooms)) %>%
      ggplot(aes(x=as.character(bedrooms_discrete), y=log(as.numeric(price)), fill=as.character(bedrooms_discrete))) + 
      geom_violin() +
      theme(text = element_text( family = 'sans'),
            axis.title.y = element_text( size = 14),
            axis.title.x = element_blank(),
            plot.title = element_blank(),
            legend.title = element_blank(),
            axis.text.x = element_text(face = 'bold', size = 12),
            axis.text.y = element_text(face = 'bold', size = 12),
            legend.position = 'none') +
      scale_x_discrete() +
      ylab('Precio de publicación (en logaritmos)') +
      geom_boxplot(width=0.1, colour='black', outlier.color = 'black') +
      ylim(8,16)

```







```{r area, fig.cap='Histograma del área cubierta (en m2). Cómo es de esperar dado que estamos trabajando con información de casas, el área total y área cubierta resulta similar'}

casas %>% select(covered_area, total_area) %>% 
      pivot_longer(cols = c('covered_area','total_area'), names_to = c('Area')) %>% 
      ggplot() +
      geom_histogram(aes(x = value, fill = Area)) +
      theme(axis.ticks.x = element_blank(),
            legend.position = 'none',
            axis.title.y = element_blank(),
            axis.title.x = element_text(face = 'bold', size = 12),
            axis.text.x = element_text(face = 'bold')) +
      xlim(0,700) +
      labs(x = 'Área (en m2)') +
      scale_fill_manual(values = c('firebrick', 'darkgreen')) +
      facet_wrap(~Area)
```


```{r calidadpic, fig.cap='Gráfico de barras de la calidad de la imágen' }

casas %>% ggplot() +
      geom_bar(aes(x = fct_infreq(as.factor(tags)), y = (..count..)/sum(..count..), fill = tags)) +
      theme(axis.ticks.x = element_blank(),
            legend.position = 'none',
            axis.title.y = element_blank(),
            axis.title.x = element_text(face = 'bold', size = 12),
            axis.text.x = element_text(face = 'bold')) + 
      scale_y_continuous(labels = scales::percent) +
      geom_text(aes(x = as.factor(tags),label = scales::percent(round((..count..)/sum(..count..), 2)), 
                    y = (..count..)/sum(..count..)), stat = "count", vjust = -0.5, size = 4) + 
      labs(x = 'Calidad de la imágen')

```


```{r preciopic, fig.cap='Gráfico de Violin del precio de publicación (en logaritmos) según la calidad de la imagen'}

casas %>% ggplot(aes(x=as.character(tags), y=log(price), fill=as.character(tags))) + 
      geom_violin() +
      theme(text = element_text( family = 'sans'),
            axis.title.y = element_text( size = 14),
            axis.title.x = element_blank(),
            plot.title = element_blank(),
            legend.title = element_blank(),
            axis.text.x = element_text(face = 'bold', size = 12),
            axis.text.y = element_text(face = 'bold', size = 12),
            legend.position = 'none')  +
      ylab('Precio de publicación (en logaritmos)') +
      geom_boxplot(width=0.1, colour='black', outlier.color = 'black') +
      scale_fill_manual(values = c('navyblue', 'darkgreen', 'firebrick', 'gray')) # no reconoce color

```





```{r aircond, fig.cap = 'Tiene aire acondicionado'}
casas %>% ggplot() +
      geom_bar(aes(x = fct_infreq(as.factor(has_air_conditioning)), y = (..count..)/sum(..count..), fill = has_air_conditioning)) +
      theme(axis.ticks.x = element_blank(),
            legend.position = 'none',
            axis.title.y = element_blank(),
            axis.title.x = element_text(face = 'bold', size = 12),
            axis.text.x = element_text(face = 'bold')) + 
      scale_y_continuous(labels = scales::percent) +
      geom_text(aes(x = as.factor(has_air_conditioning),label = scales::percent(round((..count..)/sum(..count..), 2)), 
                    y = (..count..)/sum(..count..)), stat = "count", vjust = -0.5, size = 4) + 
      labs(x = 'Tiene aire acondicionado')



```




```{r line, fig.cap = 'Tiene línea telefónica'}
casas %>% ggplot() +
      geom_bar(aes(x = fct_infreq(as.factor(has_telephone_line)), y = (..count..)/sum(..count..), fill = has_telephone_line)) +
      theme(axis.ticks.x = element_blank(),
            legend.position = 'none',
            axis.title.y = element_blank(),
            axis.title.x = element_text(face = 'bold', size = 12),
            axis.text.x = element_text(face = 'bold')) + 
      scale_y_continuous(labels = scales::percent) +
      geom_text(aes(x = as.factor(has_telephone_line),label = scales::percent(round((..count..)/sum(..count..), 2)), 
                    y = (..count..)/sum(..count..)), stat = "count", vjust = -0.5, size = 4) + 
      labs(x = 'Tiene línea telefónica')
```


\newpage

```{r, results='asis'}
kable(casas %>% filter(state_name == 'Montevideo') %>%
            group_by(city_name) %>% summarise(conteo = n()) %>%
            mutate(prop = conteo/sum(conteo)*100) %>%
            arrange(desc(prop)) %>% filter(prop > 2)) 

```

